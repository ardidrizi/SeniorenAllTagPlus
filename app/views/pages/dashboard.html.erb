<main class="dashboard-page">
  <header class="dashboard-hero mb-4">
    <div>
      <p class="eyebrow text-primary">Welcome back, <%= current_user.first_name %>!</p>
      <h1 class="display-5 fw-bold text-dark">Curated moments to keep your days meaningful.</h1>
      <p class="text-muted">
        Review your activities, chat with friends, and open the door for new adventures.
      </p>
    </div>
    <div class="dashboard-actions">
      <%= link_to "Create an activity", new_activity_path, class: "btn btn-primary" %>
      <%= link_to "Browse calendar", activities_path, class: "btn btn-outline-secondary ms-2" %>
    </div>
  </header>

  <section class="dashboard-grid">
    <article class="dashboard-card">
      <div class="dashboard-card__header">
        <h2>My activities</h2>
        <span class="badge rounded-pill bg-light text-dark"><%= @my_activities.count %></span>
      </div>
      <div class="dashboard-card__body">
        <% if @my_activities.any? %>
          <div class="stacked-items">
            <% @my_activities.each do |activity| %>
              <div class="stacked-item">
                <div class="stacked-item__image">
                  <%= cloudinary_or_active_storage_image_tag(
                    activity.photos.first,
                    default: "bar.png",
                    class: "stacked-image"
                  ) %>
                </div>
                <div class="stacked-item__content">
                  <%= link_to activity_path(activity), class: "stacked-item__title" do %>
                    <%= activity.name %>
                  <% end %>
                  <p class="stacked-item__meta"><%= activity.date_time.strftime('%^a, %d %^b, %Y at %H:%M') %></p>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-muted">You haven't created any activities yet.</p>
        <% end %>
      </div>
    </article>

    <article class="dashboard-card">
      <div class="dashboard-card__header">
        <h2>Participants</h2>
        <span class="badge rounded-pill bg-light text-dark"><%= @my_activity_bookings.count %></span>
      </div>
      <div class="dashboard-card__body">
        <% if @my_activity_bookings.any? %>
          <div class="stacked-items">
            <% @my_activity_bookings.each do |booking| %>
              <div class="stacked-item">
                <div class="stacked-item__image">
                  <%= cloudinary_or_active_storage_image_tag(
                    booking.participant.profile_image,
                    default: "user.png",
                    class: "stacked-avatar"
                  ) %>
                </div>
                <div class="stacked-item__content">
                  <p class="fw-semibold mb-0">
                    <%= [booking.participant.first_name, booking.participant.last_name].join(" ") %>
                  </p>
                  <p class="stacked-item__meta"><%= booking.activity.name %></p>
                  <div class="stacked-item__actions">
                    <% if booking.status.nil? %>
                      <%= link_to decline_booking_path(booking), method: :get, class: "btn btn-sm btn-outline-danger me-2" do %>
                        Decline
                      <% end %>
                      <%= link_to accept_booking_path(booking), method: :get, class: "btn btn-sm btn-outline-success" do %>
                        Accept
                      <% end %>
                    <% elsif booking.status %>
                      <span class="badge rounded-pill text-bg-success">Approved</span>
                    <% else %>
                      <span class="badge rounded-pill text-bg-danger">Declined</span>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-muted">No one has requested to join your activities yet.</p>
        <% end %>
      </div>
    </article>

    <article class="dashboard-card">
      <div class="dashboard-card__header">
        <h2>My bookings</h2>
        <span class="badge rounded-pill bg-light text-dark"><%= @my_bookings.count %></span>
      </div>
      <div class="dashboard-card__body">
        <% if @my_bookings.any? %>
          <div class="stacked-items">
            <% @my_bookings.each do |booking| %>
              <div class="stacked-item">
                <div class="stacked-item__image">
                  <%= cloudinary_or_active_storage_image_tag(
                    booking.activity.photos.first,
                    default: "bar.png",
                    class: "stacked-image"
                  ) %>
                </div>
                <div class="stacked-item__content">
                  <%= link_to activity_path(booking.activity_id), class: "stacked-item__title" do %>
                    <%= booking.activity.name %>
                  <% end %>
                  <p class="stacked-item__meta">
                    <%= booking.activity.date_time.strftime('%^a, %d %^b, %Y at %H:%M') %>
                  </p>
                  <div class="stacked-item__actions">
                    <% if booking.status.nil? %>
                      <span class="badge rounded-pill text-bg-warning">Waiting for approval</span>
                    <% elsif booking.status %>
                      <span class="badge rounded-pill text-bg-success">Approved</span>
                      <%= link_to "Leave", booking_path(booking.id), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, class: "btn btn-sm btn-outline-danger ms-2" %>
                    <% else %>
                      <span class="badge rounded-pill text-bg-danger">Declined</span>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-muted">You haven't joined any activities yet.</p>
        <% end %>
      </div>
    </article>
  </section>
</main>
